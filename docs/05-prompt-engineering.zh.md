# 提示词工程指南

> **语言 (Language)**: [English](05-prompt-engineering.md) | 简体中文

**掌握与 Claude Code 沟通的艺术，最大化生产力**

---

## 目录

1. [介绍](#介绍)
2. [提示词解析](#提示词解析)
3. [有效的提示词技巧](#有效的提示词技巧)
4. [特定任务的提示词](#特定任务的提示词)
5. [上下文管理](#上下文管理)
6. [多步骤工作流](#多步骤工作流)
7. [错误处理](#错误处理)
8. [高级模式](#高级模式)
9. [常见陷阱](#常见陷阱)

---

## 介绍

有效的提示词工程是解锁 Claude Code 全部潜力的关键。本指南教你如何清晰地表达意图、提供正确的上下文，以及为复杂任务构建最优结构。

### 为什么提示词工程很重要

- **效率**: 第一次就获得准确的结果
- **质量**: 获得结构良好、易于维护的代码
- **上下文控制**: 在提供必要信息的同时最小化 token 使用
- **可预测性**: 理解 Claude Code 如何解释你的请求

---

## 提示词解析

### 基本结构

每个有效的提示词都有三个组成部分：

```
[意图] + [上下文] + [约束]
```

**示例：**

```
意图: "实现用户认证"
上下文: "使用 JWT token 和 bcrypt 进行密码哈希"
约束: "遵循 src/middleware/auth.js 中的现有认证模式"
```

**完整提示词：**

```
使用 JWT token 和 bcrypt 进行密码哈希来实现用户认证。
遵循 src/middleware/auth.js 中的现有认证模式。
```

### 组件分解

#### 1. 意图（"做什么"）

明确指定你想要实现的目标：

```
❌ "修复 bug"
✅ "修复 getUserById 中当用户不存在时的空指针异常"

❌ "添加验证"
✅ "为用户注册表单添加电子邮件格式验证"

❌ "改进性能"
✅ "优化 getUsersByRole 中的数据库查询以减少执行时间"
```

#### 2. 上下文（"为什么"和"在哪里"）

提供相关的背景信息：

```
✅ "登录函数对密码中包含特殊字符的用户失败。
   问题似乎在 src/auth/login.js 的第 45 行附近。"

✅ "我需要为用户资料更新添加新的 API 端点。
   现有的用户端点在 src/routes/users.js 中。"

✅ "按照我们的 TDD 工作流，我想在实现
   密码重置功能之前先添加测试。"
```

#### 3. 约束（"如何做"）

指定要求、模式或限制：

```
✅ "使用现有的 try-catch 块错误处理模式"
✅ "遵循常规提交消息格式"
✅ "确保与 v1 API 的向后兼容性"
✅ "保持更改最小化 - 仅修改必要的文件"
```

---

## 有效的提示词技巧

### 1. 具体明确

**模糊 vs. 具体：**

| ❌ 模糊         | ✅ 具体                                                                                     |
| ---------------- | ----------------------------------------------------------------------------------------------- |
| "添加测试"      | "为 getUserById 函数添加单元测试，涵盖成功、未找到和无效 ID 的情况" |
| "让它更快" | "通过在 category 列上添加索引来优化产品搜索查询"                   |
| "修复样式"    | "将提交按钮向右对齐并将其颜色更改为 #007bff"                          |

### 2. 提供示例

**示例驱动的提示词：**

```
创建一个用于删除用户的新 API 端点。遵循 src/routes/users.js 中
现有 POST /users 端点的相同模式：

- 使用 Express 路由器
- 添加输入验证中间件
- 成功时返回 204 状态
- 包含错误处理
```

### 3. 使用增量细化

将复杂任务分解为步骤：

```
步骤 1: "首先，显示当前处理用户密码的所有位置"

步骤 2: "现在，使用 bcrypt 创建密码哈希实用函数"

步骤 3: "更新注册端点以使用新的密码哈希函数"

步骤 4: "为密码哈希实用函数添加测试"
```

### 4. 参考项目标准

利用你的 CLAUDE.md 文件：

```
✅ "按照 CLAUDE.md 中定义的 TDD 工作流，先写测试"
✅ "使用编码标准部分中的错误处理模式"
✅ "遵循我们文档中指定的常规提交格式"
```

### 5. 请求解释

要求 Claude Code 解释其推理：

```
"解释为什么 getUserById 对有效 ID 返回 null，然后提出修复方案"

"分析搜索函数中的性能瓶颈并建议
 包含权衡的优化方案"

"审查在 localStorage 中存储用户 token 与在 cookie 中存储的
 安全含义"
```

---

## 特定任务的提示词

### 调试

**模式：**

```
[症状] + [预期行为] + [相关代码位置]
```

**示例：**

```
"登录端点对无效凭证返回 500 而不是 401。
 预期: 401 状态和错误消息 'Invalid credentials'
 位置: src/routes/auth.js 第 23-45 行"
```

```
"用户资料图片上传后无法显示。
 预期: 应返回图片 URL 且图片应可访问
 相关文件: src/controllers/uploadController.js, src/services/storage.js"
```

### 功能实现

**模式：**

```
[功能描述] + [验收标准] + [实现方法]
```

**示例：**

```
"实现用户密码重置功能。

验收标准:
- 用户通过提供电子邮件请求重置
- 系统通过电子邮件发送重置 token
- Token 在 1 小时后过期
- 用户可以使用有效 token 设置新密码

方法:
- 遵循现有电子邮件服务模式
- 使用 crypto 生成安全 token
- 在数据库中存储带有过期时间的 token"
```

### 代码审查

**模式：**

```
[请求类型] + [关注领域] + [代码位置]
```

**示例：**

```
"审查 src/middleware/auth.js 中的认证中间件，关注：
- 安全漏洞
- 错误处理的完整性
- 性能问题
- 代码风格一致性"
```

### 重构

**模式：**

```
[当前问题] + [期望状态] + [约束]
```

**示例：**

```
"UserService 类已增长到 500 行，职责过多。

期望状态:
- 分解为 UserService、UserValidator 和 UserRepository
- 每个类都有单一职责
- 保持现有 API 兼容性

约束:
- 不要破坏现有测试
- 保持更改在 src/services/ 目录中"
```

### 测试

**模式：**

```
[测试类型] + [覆盖要求] + [场景]
```

**示例：**

```
"为 getUserById 函数编写单元测试。

覆盖要求:
- 快乐路径: 用户存在
- 错误情况: 用户未找到、无效 ID、数据库错误
- 边界情况: null/undefined ID

使用 Jest 和 tests/services/userService.spec.js 中的现有测试设置"
```

---

## 上下文管理

### 何时提供上下文

**始终包含：**

- 错误消息和堆栈跟踪
- 相关文件路径
- 预期 vs. 实际行为

**有时包含：**

- 相关代码片段（如果文件中还没有）
- 项目结构概览
- 依赖项和版本

**避免：**

- 整个文件转储（让 Claude 读取文件）
- 无关的历史信息
- 对话中已有的明显上下文

### 高效的上下文提供

**❌ 低效：**

```
"这是我的整个 userService.js 文件: [粘贴 500 行代码]
能修复 bug 吗？"
```

**✅ 高效：**

```
"src/services/userService.js 中的 getUserById 有 bug，大约在第 45 行。
当用户不存在时，它返回 null 而不是抛出 UserNotFoundError。
能读取文件并修复吗？"
```

### 文件引用

**绝对路径：**

```
✅ "读取 src/services/userService.js"
❌ "读取用户服务文件"
```

**行号：**

```
✅ "问题在 src/auth/login.js:23-45"
✅ "更新 src/utils/validation.js:67 中的验证逻辑"
```

### 利用工具内存

Claude Code 在会话中记住工具结果：

```
"读取 src/services/userService.js"
[Claude 读取文件]

"现在为 getUserById 函数添加错误处理"
[Claude 有来自之前读取的上下文]

"也为 getUserByEmail 添加类似的错误处理"
[Claude 仍然有文件上下文]
```

---

## 多步骤工作流

### 顺序任务

**模式：**

```
任务 1: [描述]
然后任务 2: [描述]
最后任务 3: [描述]
```

**示例：**

```
任务 1: 读取 src/auth/ 中的现有认证代码
任务 2: 识别安全漏洞
任务 3: 创建计划以最小化破坏性更改来修复它们
```

### 条件工作流

**模式：**

```
如果 [条件]，则 [操作 A]，否则 [操作 B]
```

**示例：**

```
"检查我们是否有 UserRepository 类。
如果有，重构 UserService 以使用它。
如果没有，首先创建遵循存储库模式的 UserRepository，
然后重构 UserService。"
```

### 迭代细化

**模式：**

```
初始请求 → 审查 → 反馈 → 细化
```

**示例：**

```
你: "创建用户验证函数"
Claude: [创建基本验证]

你: "添加使用正则表达式的电子邮件格式验证"
Claude: [更新函数]

你: "还要验证密码强度: 最少 8 个字符、1 个大写字母、1 个数字"
Claude: [增强验证]

你: "将验证规则提取到常量以便重用"
Claude: [使用常量重构]
```

---

## 错误处理

### 当错误发生时

**使用上下文报告错误：**

```
❌ "它不工作"

✅ "测试失败，错误为: 'TypeError: Cannot read property 'id' of null'
   在 tests/userService.spec.js:23
   这发生在你添加 getUserById 函数之后"
```

### 调试提示词

**模式：**

```
[错误消息] + [何时发生] + [你尝试过什么]
```

**示例：**

```
"错误: 'Module not found: cannot resolve ./userService'

这发生在添加新 UserService 类后运行 npm test 时。

我尝试过:
- 检查导入路径（看起来正确）
- 验证文件存在（它确实在 src/services/userService.js）

什么出错了？"
```

### 请求修复

**明确指定期望的结果：**

```
❌ "修复这个"

✅ "通过在访问 user.id 之前添加 null 检查来修复空指针错误"

✅ "通过在测试设置中模拟数据库调用来修复失败的测试"
```

---

## 高级模式

### 基于约束的提示词

**定义不要做什么：**

```
"重构认证系统以使用 JWT token。

约束:
- 不要更改数据库架构
- 不要破坏现有 API 端点
- 不要引入新依赖项
- 保持与基于会话的认证的向后兼容性"
```

### 比较提示词

**请求权衡分析：**

```
"比较两种实现实时通知的方法：

方法 A: WebSockets with Socket.io
方法 B: Server-Sent Events (SSE)

分析：
- 性能影响
- 浏览器兼容性
- 实现复杂性
- 可扩展性

推荐一种并说明理由。"
```

### 基于模板的提示词

**提供结构：**

```
"使用此模板创建新 API 端点：

路由: POST /api/[RESOURCE]
验证: [列出必需字段]
业务逻辑: [描述操作]
响应: [定义成功/错误响应]
测试: [列出测试场景]

为创建新博客文章填写。"
```

### 探索性提示词

**用于学习代码库：**

```
"探索此代码库中用户认证的工作原理。

要回答的问题：
1. 使用什么认证策略？(JWT、会话、OAuth 等)
2. 凭证在哪里验证？
3. 路由如何受保护？
4. 用户会话数据存储在哪里？

从检查认证中间件和路由开始。"
```

---

## 常见陷阱

### ❌ 陷阱 1: 过度解释

**问题：**

```
"我想添加一个函数，它以用户 ID 作为输入，这是一个字符串，
然后查询数据库，这是运行在端口 5432 上的 PostgreSQL，
使用 Sequelize ORM 版本 6.x，并返回用户对象，它
应该有 id、name、email 和 createdAt 字段..."
```

**解决方案：**

```
"添加一个 getUserById 函数，查询数据库并返回用户对象。
遵循 UserService 中的现有模式。"
```

### ❌ 陷阱 2: 指定不足

**问题：**

```
"添加验证"
```

**解决方案：**

```
"为用户注册端点添加电子邮件和密码验证：
- 电子邮件: 必须是有效格式
- 密码: 最少 8 个字符、1 个大写字母、1 个数字、1 个特殊字符"
```

### ❌ 陷阱 3: 假设上下文

**问题：**

```
"修复我们之前讨论的那个函数中的 bug"
```

**解决方案：**

```
"修复 getUserById 函数中的空指针 bug (src/services/userService.js:45)"
```

### ❌ 陷阱 4: 多个不相关的请求

**问题：**

```
"添加用户认证、修复主页样式、更新 README，
并优化数据库查询"
```

**解决方案：**

```
请求 1: "使用 JWT token 添加用户认证"
[完成]

请求 2: "修复主页样式: 居中英雄部分并为按钮使用 #007bff"
[完成]

请求 3: "使用安装说明更新 README"
[完成]
```

### ❌ 陷阱 5: 不利用工具内存

**问题：**

```
"这是 userService.js 的内容: [粘贴整个文件]
现在添加一个函数"
```

**解决方案：**

```
"读取 src/services/userService.js"
[Claude 读取]

"现在添加一个 getUsersByRole 函数，遵循现有模式"
[Claude 有上下文]
```

---

## 提示词模板

### 模板: Bug 修复

```
BUG: [意外行为的描述]
预期: [应该发生什么]
位置: [文件路径和行号（如果已知）]
错误: [错误消息（如果适用）]
上下文: [何时发生？什么触发它？]

请：
1. 调查原因
2. 提出修复方案
3. 解释为什么会出现 bug
```

### 模板: 功能实现

```
功能: [功能名称和描述]

要求:
- [要求 1]
- [要求 2]
- [要求 3]

方法:
- [实现细节 1]
- [实现细节 2]

约束:
- [约束 1]
- [约束 2]

遵循 [参考模式/文件] 以保持一致性。
```

### 模板: 代码审查

```
审查: [文件或函数名称]

关注领域:
- 安全漏洞
- 性能问题
- 代码风格和可维护性
- 测试覆盖率
- 错误处理

提供：
1. 发现的问题（严重程度: 严重/主要/次要）
2. 具体建议
3. 修复的代码示例
```

### 模板: 重构

```
重构: [要重构的组件/文件]

当前问题:
- [问题 1]
- [问题 2]

期望状态:
- [目标 1]
- [目标 2]

约束:
- [约束 1]
- [约束 2]

在进行更改之前创建重构计划。
```

### 模板: 测试

```
测试: [要测试的函数/组件]

测试类型: [单元/集成/E2E]

场景:
- 快乐路径: [描述]
- 错误情况: [列表]
- 边界情况: [列表]

覆盖目标: [百分比或特定行]

使用 [测试框架和现有模式]。
```

---

## 最佳实践总结

### ✅ 应该做的

1. **具体明确**
   - 准确说明你想要什么
   - 提供相关上下文
   - 定义成功标准

2. **使用文件引用**
   - 按路径引用文件
   - 在相关时包含行号
   - 让 Claude 读取文件而不是粘贴内容

3. **分解复杂任务**
   - 一次一个任务
   - 依赖关系的顺序步骤
   - 迭代和细化

4. **利用项目上下文**
   - 参考 CLAUDE.md 标准
   - 指向现有模式
   - 使用一致的术语

5. **提供反馈**
   - 在结果正确时确认
   - 指定需要调整的内容
   - 解释你的推理

### ❌ 不应该做的

1. **不要粘贴大代码块**
   - 使用文件引用
   - 让 Claude 读取文件
   - 关注相关部分

2. **不要假设未说明的上下文**
   - Claude 不会读心术
   - 明确说明要求
   - 如果需要参考之前的对话

3. **不要混合多个任务**
   - 一次一个请求
   - 在继续之前完成每个
   - 分组相关子任务

4. **不要过度约束**
   - 指定结果，不是实现细节
   - 相信 Claude 的"如何"判断
   - 关注"什么"和"为什么"

5. **不要忽视错误**
   - 立即报告问题
   - 提供完整错误消息
   - 包含发生时的上下文

---

## 真实世界示例

### 示例 1: 实现认证

**❌ 差的提示词：**

```
"添加认证"
```

**✅ 好的提示词：**

```
"为 REST API 实现基于 JWT 的认证。

要求:
- 登录端点: POST /api/auth/login (接受 email/password)
- 返回有效期为 24 小时的 JWT token
- 使用 bcrypt 进行密码哈希 (10 轮)
- 中间件保护需要认证的路由

遵循 src/middleware/errorHandler.js 中的错误处理模式。
使用 src/models/User.js 中的现有 User 模型。

按照我们的 TDD 工作流，先写测试。"
```

### 示例 2: 调试性能

**❌ 差的提示词：**

```
"应用很慢"
```

**✅ 好的提示词：**

```
"/api/products 搜索端点在按类别搜索时需要 5-8 秒才能响应。

预期: < 500ms 响应时间

相关代码: src/controllers/productController.js:45-78

我怀疑它在做全表扫描。能否：
1. 分析当前查询
2. 识别瓶颈
3. 提出优化方案（索引、查询更改、缓存）
4. 估计性能改进"
```

### 示例 3: 代码重构

**❌ 差的提示词：**

```
"清理代码"
```

**✅ 好的提示词：**

```
"重构 UserController 类 (src/controllers/UserController.js)
以改进可维护性。

当前问题:
- 单个文件中 400+ 行
- 混合业务逻辑和 HTTP 处理
- 控制器中直接的数据库查询
- 没有关注点分离

期望状态:
- 将业务逻辑提取到 UserService
- 将数据库操作提取到 UserRepository
- 控制器仅处理 HTTP (验证、响应格式化)
- 遵循 ProductRepository 中使用的存储库模式

约束:
- 保持现有 API 契约
- 不要破坏现有测试（如需要更新测试）
- 一次完成一个提取以供审查"
```

---

## 交互式提示词细化

### 技巧: 渐进式披露

从广泛开始，然后根据 Claude 的问题进行细化：

```
你: "我需要添加用户认证"

Claude: "我可以帮助。几个问题：
1. 什么认证方法？(JWT、会话、OAuth)
2. Token 应该存储在哪里？(localStorage、cookie、header)
3. 哪些路由需要保护？
4. 有特定的安全要求吗？"

你: "JWT token，存储在 HTTP-only cookie 中，保护所有 /api/users/* 路由，
     token 应在 24 小时后过期"

Claude: [基于细化的要求实现]
```

### 技巧: 澄清循环

```
你: "登录坏了"

Claude: "我需要更多细节来帮助：
- 你看到什么错误消息？
- 重现的步骤是什么？
- 预期的行为是什么？
- 有相关的文件或行号吗？"

你: "错误: 'Invalid credentials' 对于有效的用户名/密码。
     步骤: 转到 /login，输入 test@example.com / password123
     预期: 应该成功登录
     文件: src/controllers/authController.js"

Claude: [调查并修复]
```

---

## 结论

有效的提示词工程将 Claude Code 从有用的助手转变为强大的开发伙伴。关键要点：

1. **清晰是王道**: 具体、结构良好的提示词产生更好的结果
2. **上下文很重要**: 提供足够的上下文，不要过多
3. **迭代和细化**: 将复杂任务分解为可管理的步骤
4. **从示例学习**: 使用模板和真实世界的模式
5. **利用工具内存**: 让 Claude 读取文件而不是粘贴内容

**熟能生巧：**

从简单的提示词开始，逐步尝试高级技巧。随着时间的推移，你将培养与 Claude Code 有效沟通的直觉。

---

**后续步骤：**

1. 审查 [提示词模板](#提示词模板) 部分
2. 在你的当前项目中练习
3. 探索 [高级使用指南](./06-advanced-usage.zh.md)
4. 与社区分享你自己的有效提示词

---

**相关文档：**

- [入门指南](./01-getting-started.zh.md)
- [Git 工作流指南](./04-git-workflow.zh.md)
- [高级使用](./06-advanced-usage.zh.md)

**外部资源：**

- [Anthropic 提示词工程指南](https://docs.anthropic.com/claude/docs/prompt-engineering)
- [Claude Code 文档](https://github.com/anthropics/claude-code)
